<!doctype html>
<html>
  <head>
    <title>Chat Interface</title>
    <style>
      #chat-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 300px;
        height: 400px;
        border: 1px solid black;
        padding: 10px;
        margin: 10px auto;
      }
      #chat {
        flex: 1;
        overflow-y: scroll;
        width: 100%;
        border: 1px solid black;
        padding: 10px;
        margin-bottom: 10px;
      }
      #character {
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
      }
    </style>
    <script
      src="https://cdn.socket.io/4.6.0/socket.io.min.js"
      integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"
      integrity="sha512-xi/RZRIF/S0hJ+yJJYuZ5yk6/8pCiRlEXZzoguSMl+vk2i3m6UjUO/WcZ11blRL/O+rnj94JRGwt/CHbc9+6EA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="character">
      <div id="character-data"></div>
      <img
        alt="Character Image"
        width="512"
        height="512"
        id="character-image"
      />
    </div>
    <div id="chat-container">
      <div id="chat"></div>
      <input type="text" id="messageInput" />
      <button id="sendButton">Send</button>
    </div>

    <script>
      const socket = io("http://192.168.0.37:7000");
      var notificationSound = new Howl({
        src: ["notification.mp3"],
      });

      document.addEventListener("visibilitychange", onchange);

      socket.on("connect", function () {
        appendChat({ from: "System", message: "Connected" });
      });

      socket.on("message", function (data) {
        if (document.hidden) {
          notificationSound.play();
        }

        appendChat(data);
      });

      socket.on("character", function (data) {
        document.getElementById("character-data").innerHTML =
          "Character: " + data.name + ", " + data.summary;
      });

      socket.on("image", function (data) {
        document.getElementById("character-image").src = data;
      });

      socket.on("tts", function (data) {
        var audio = new Howl({
          src: [data],
          html5: true,
        });

        audio.once("load", function () {
          console.log("Playing audio");
          audio.play();
        });

        audio.once("end", function () {
          console.log("Audio ended");
        });
      });

      document.getElementById("sendButton").onclick = function () {
        var message = document.getElementById("messageInput").value;
        socket.emit("message", { from: "User", message: message });
        appendChat({ from: "User", message: message });
        document.getElementById("messageInput").value = "";
      };

      function appendChat(data) {
        var chat = document.getElementById("chat");
        var messageElement = document.createElement("div");
        var nameElement = document.createElement("span");

        nameElement.textContent = data.from + ": ";
        nameElement.style.fontWeight = "bold";

        messageElement.appendChild(nameElement);
        messageElement.appendChild(
          document.createTextNode(getMessage(data.message, data.from)),
        );

        if (data.from === "User") {
          messageElement.style.textAlign = "right";
          messageElement.style.color = "blue";
        } else if (data.from === "System") {
          messageElement.style.textAlign = "center";
          messageElement.style.color = "red";
        } else {
          messageElement.style.color = "green";
        }

        chat.appendChild(messageElement);
        chat.scrollTop = chat.scrollHeight;
      }

      function getMessage(message, name) {
        console.log(message);

        if (message.includes(`${name}:`)) {
          return message.split(`${name}:`)[1];
        } else {
          return message;
        }
      }
    </script>
  </body>
</html>
